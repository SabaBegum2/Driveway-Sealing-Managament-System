CREATE TABLE ClientDB (
    clientID VARCHAR(20) PRIMARY KEY,
    email VARCHAR(30) NOT NULL UNIQUE,
    password VARCHAR(20) NOT NULL,
    firstName VARCHAR(20) NOT NULL,
    lastName VARCHAR(20) NOT NULL,
    phoneNumber VARCHAR(10),
    creditCardNum VARCHAR(16),
    creditCardCVV VARCHAR(3),
    creditCardExp VARCHAR(5),
    homeAddress VARCHAR(60) NOT NULL,
    registerDate DATETIME,
    loginTime DATETIME,
    activeStatus ENUM("online","offline") DEFAULT "offline"
);

CREATE TABLE QuoteRequest (
    quoteID INT AUTO_INCREMENT,
    clientID VARCHAR(20),
    propertyAddress TEXT NOT NULL,
    drivewaySqft INT,
    proposedPrice DECIMAL(10, 2) NOT NULL,
    addNote VARCHAR(300),
    PRIMARY KEY (quoteID),
    FOREIGN KEY (clientID) REFERENCES ClientDB(clientID)
);

CREATE TABLE QuoteRequestImage (
    quoteID INT,
    image1 VARCHAR(255) NOT NULL,
    image2 VARCHAR(255) NOT NULL,
    image3 VARCHAR(255) NOT NULL,
    image4 VARCHAR(255) NOT NULL,
    image5 VARCHAR(255) NOT NULL,
    FOREIGN KEY (quoteID) REFERENCES QuoteRequest(quoteID)
);


CREATE TRIGGER `addToQuoteHistory` AFTER INSERT ON `QuoteRequest`
 FOR EACH ROW BEGIN
    -- Insert into QuoteHistory only if the quoteID is not already there
    IF NOT EXISTS (
        SELECT 1 
        FROM QuoteHistory 
        WHERE quoteID = NEW.quoteID
    ) THEN
        INSERT INTO QuoteHistory (clientID, quoteID, proposedPrice, addNote, status)
        VALUES (NEW.clientID, NEW.quoteID, NEW.proposedPrice, NEW.addNote, 'Pending');
    END IF;
END


CREATE TABLE QuoteHistory (
    responseID INT AUTO_INCREMENT,
    clientID VARCHAR(20),
    quoteID INT,
    proposedPrice DECIMAL(10, 2),
    startDate DATE,
    endDate DATE,
    addNote VARCHAR(300),
    responseDATE DATE DEFAULT CURRENT_DATE,
    status ENUM('Pending', 'Rejected', 'Accepted', 'Cancelled') DEFAULT 'Pending',
    PRIMARY KEY (responseID),
    FOREIGN KEY (quoteID) REFERENCES QuoteRequest(quoteID),
    FOREIGN KEY (clientID) REFERENCES QuoteRequest(clientID)
);


CREATE TRIGGER `createWorkOrder` AFTER UPDATE ON `QuoteHistory`
FOR EACH ROW
  BEGIN
    IF NEW.status = 'Accepted' THEN
      INSERT INTO WorkOrder( clientID, quoteID, responseID, dateRange)
VALUES(NEW.clientID, NEW.quoteID, NEW.responseID, CONCAT(NEW.startDate, ' to ', NEW.endDate));
    END IF;
END


CREATE TABLE WorkOrder (
    workOrderID INT PRIMARY KEY AUTO_INCREMENT,
    clientID VARCHAR(20),
    quoteID INT,
    responseID INT,
    dateRange VARCHAR(30),
    status ENUM('Scheduled', 'Completed', 'Cancelled') DEFAULT 'Scheduled',
    FOREIGN KEY (clientID) REFERENCES ClientDB(clientID),
    FOREIGN KEY (quoteID) REFERENCES QuoteRequest(quoteID),
    FOREIGN KEY (responseID) REFERENCES QuoteHistory(responseID)
);


-- Optional if only testing Client end: --
CREATE TRIGGER `afterOrderCompleted` AFTER UPDATE ON `WorkOrder`
 FOR EACH ROW BEGIN
    IF NEW.status = 'Completed' THEN
        INSERT INTO Invoice (workOrderID, clientID, amountDue, dateCreated)
        SELECT NEW.workOrderID, NEW.clientID, qh.proposedPrice, NOW()
        FROM QuoteHistory qh
        WHERE qh.responseID = NEW.responseID;
    END IF;
END


CREATE TABLE Invoice (
    invoiceID INT PRIMARY KEY AUTO_INCREMENT,
    workOrderID INT,
    clientID VARCHAR(20),
    amountDue DECIMAL(10, 2),
    dateCreated DATETIME,
    datePaid DATETIME DEFAULT NULL,
    status enum('DUE','OVERDUE','PAID','ADJUSTED') DEFAULT 'DUE',
    discount decimal(10,2) DEFAULT 0.00
    FOREIGN KEY (workOrderID) REFERENCES WorkOrder(workOrderID),
    FOREIGN KEY (clientID) REFERENCES ClientDB(clientID)
);

CREATE TABLE InvoiceResponses (
    responseID INT PRIMARY KEY AUTO_INCREMENT,
    invoiceID INT NOT NULL,
    clientID varchar(20) DEFAULT NULL,
    responseNote VARCHAR(500),
    responseDate DATETIME DEFAULT current_timestamp(),
    FOREIGN KEY (invoiceID) REFERENCES Invoice(invoiceID)
);


-- For Demonstration: Insert Value Tuples

INSERT INTO ClientDB (clientID, email, password, firstName, lastName, phoneNumber, creditCardNum, creditCardCVV, creditCardExp, homeAddress, registerDate, loginTime, activeStatus) VALUES
    ("C001", "john.doe@example.com", "password123", "John", "Doe", "1234567890", "4111111111111111", "123", "12/25", "123 Main St, Anytown, USA", "2024-11-27 08:00:00", "2024-11-27 08:30:00", "online"),
    ("C002", "jane.smith@example.com", "securePass1", "Jane", "Smith", "0987654321", "5500000000000004", "456", "07/26", "456 Elm St, Othertown, USA", "2024-11-26 09:00:00", "2024-11-27 10:00:00", "offline");

INSERT INTO QuoteRequest (clientID, propertyAddress, drivewaySqft, proposedPrice, addNote) VALUES
    ("C001", "123 Main St, Anytown, USA", 1200, 250.00, "Please prioritize this job as soon as possible."),
    ("C002", "456 Elm St, Othertown, USA", 800, 200.00, "Driveway has some cracks; please inspect closely.");

INSERT INTO QuoteRequestImage (quoteID, image1, image2, image3, image4, image5) VALUES
    (1, "images/driveway1.jpg", "images/driveway2.jpg", "images/driveway3.jpg", "images/driveway4.jpg", "images/driveway5.jpg"),
    (2, "images/drivewayA.jpg", "images/drivewayB.jpg", "images/drivewayC.jpg", "images/drivewayD.jpg", "images/drivewayE.jpg");

INSERT INTO QuoteHistory (clientID, quoteID, proposedPrice, startDate, endDate, addNote, status) VALUES
    ("C001", 1, 275.00, "2024-12-01", "2024-12-03", "Initial counter proposal from David Smith.", "Pending"),
    ("C002", 2, 220.00, "2024-12-05", "2024-12-06", "Proposed time and price by David Smith.", "Pending");

INSERT INTO WorkOrder (clientID, quoteID, responseID, dateRange, status) VALUES
    ("C001", 1, 1, "2024-12-01 to 2024-12-03", "Scheduled"),
    ("C002", 2, 2, "2024-12-05 to 2024-12-06", "Scheduled");

INSERT INTO Invoice (workOrderID, clientID, amountDue, dateCreated, datePaid) VALUES
    (1, "C001", 275.00, "2024-12-04 12:00:00", NULL),
    (2, "C002", 220.00, "2024-12-07 10:00:00", NULL);

INSERT INTO InvoiceResponses (invoiceID, responseNote, responseDate) VALUES
    (1, "The amount seems higher than expected. Can you clarify?", "2024-12-05"),
    (2, "I need an explanation for the additional charges.", "2024-12-08");


----------------------------------------------------------------------
----------------------------------------------------------------------
-------			For Both's database		 -------------
----------------------------------------------------------------------
----------------------------------------------------------------------

-- Register new user
     INSERT INTO ClientDB (clientID, email, password, firstName, lastName, phoneNumber, creditCardNum, creditCardCVV, creditCardExp, homeAddress, registerDate, loginTime)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

-- Sign in function to search for login credentials
    UPDATE ClientDB SET loginTime = ?, activeStatus = ? WHERE clientID = ? AND password = ?;



----------------------------------------------------------------------
----------------------------------------------------------------------
-------			For Client's database		 -------------
----------------------------------------------------------------------
----------------------------------------------------------------------

------- CLIENT MAIN PAGE -------

-- CLIENT INFO
     SELECT * FROM ClientDB WHERE clientID LIKE ?

-- Log Client out
     UPDATE ClientDB SET activeStatus = ? WHERE clientID = ?

-- Create quote request
	// Insert into QuoteRequest table
    INSERT INTO QuoteRequest (clientID, propertyAddress, drivewaySqft, proposedPrice, addNote) VALUES (?, ?, ?, ?, ?);
	// Insert images into QuoteRequestImage table
    INSERT INTO QuoteRequestImage (quoteID, image1, image2, image3, image4, image5) VALUES (?, ?, ?, ?, ?, ?);


------- QUOTE HISTORY PAGE -------

-- QUOTE HISTORY
    SELECT 
       QH.responseID,
       QH.quoteID,
       QR.propertyAddress,
       QR.drivewaySqft,
       QH.proposedPrice,
       QH.startDate,
       QH.endDate,
       QH.addNote,
       QH.responseDate,
       QH.status,
       CASE 
	  WHEN QH.responseID = (
	     SELECT MAX(responseID)
	     FROM QuoteHistory
	     WHERE quoteID = QH.quoteID
	  ) AND QH.status = 'Pending'
	  THEN 1
	  ELSE 0
       END AS isMostRecentPending
       FROM QuoteHistory QH
       JOIN QuoteRequest QR ON QH.quoteID = QR.quoteID
       WHERE QH.clientID = ?
       ORDER BY  QH.quoteID, QH.responseID ASC;

-- GET QUOTE RESPONSES FOR CLIENT
	// Grab the proposedPrice, startDate, and endDate if they're NULL in the passed parameters
    SELECT * FROM QuoteHistory WHERE responseID = ?;
	// Return the responseID result and grab missing parameters from client response
    INSERT INTO QuoteHistory (clientID, quoteID, proposedPrice, startDate, endDate, addNote, status) VALUES (?, ?, ?, ?, ?, ?, ?);

-- ACCEPT QOUTE FROM CLIENT
	// Verify responseID was properly grabbed and grab the start and end dates to send back
    SELECT * FROM QuoteHistory WHERE responseID = ?;
	// Update response to Accepted
    UPDATE QuoteHistory 
    SET status = 'Accepted', startDate = ?, endDate = ? 
    WHERE responseID = ?;


------- WORK ORDER HISTORY PAGE -------

-- GET WORK ORDER HISTORY FOR CLIENT
    SELECT 
       WO.workOrderID,
       WO.quoteID,
       WO.clientID,
       QR.propertyAddress,
       WO.dateRange,
       QH.proposedPrice AS price,
       WO.status
    FROM WorkOrder WO
    JOIN QuoteRequest QR ON WO.quoteID = QR.quoteID
    JOIN QuoteHistory QH ON WO.responseID = QH.responseID
    WHERE WO.clientID LIKE ?;

-- WORK ORDER CANCELLED BY CLIENT
    UPDATE WorkOrder SET status = 'CANCELLED' WHERE workOrderID = ?;


------- INVOICE HISTORY PAGE -------

-- GET INVOICE HISTORY FOR CLIENT
	// Make sure OVERDUE was marked before they see their data
    UPDATE Invoice SET status = 'Overdue' WHERE datePaid IS NULL AND DATEDIFF(CURDATE(), dateCreated) > 7;
	// Get invoice history for a client
    SELECT 
         I.status,
          I.invoiceID,
          I.workOrderID,
          I.clientID,
          0 AS responseID, -- Define the initial invoice with responseID = 0
          I.amountDue,
          I.discount,
          I.dateCreated,
          I.datePaid,
          'INITIAL INVOICE' AS responseNote, -- Custom note for the initial invoice
          I.dateCreated AS responseDate, -- Use the invoice creation date for the initial entry
          QR.propertyAddress, -- Include propertyAddress from QuoteRequest
          CASE 
               WHEN (I.status = 'DUE' OR I.status = 'OVERDUE') AND NOT EXISTS (
                  SELECT 1 
                  FROM InvoiceResponses IR2 
                  WHERE IR2.invoiceID = I.invoiceID
               )
               THEN 1
               ELSE 0
            END AS isMostRecentPaid -- For the initial invoice rows
            FROM Invoice I
            LEFT JOIN WorkOrder WO ON I.workOrderID = WO.workOrderID
            LEFT JOIN QuoteHistory QH ON WO.responseID = QH.responseID
            LEFT JOIN QuoteRequest QR ON QH.quoteID = QR.quoteID
            WHERE I.clientID = ?
            
            UNION ALL
            
            SELECT 
               I.status,
               I.invoiceID,
               I.workOrderID,
               I.clientID,
               IR.responseID,
               I.amountDue,
               I.discount,
               I.dateCreated,
               I.datePaid,
               IR.responseNote,
               IR.responseDate,
               QR.propertyAddress, -- Include propertyAddress from QuoteRequest
               CASE 
                  WHEN (I.status = 'DUE' OR I.status = 'OVERDUE') AND IR.responseID = (
                     SELECT MAX(IR2.responseID)
                     FROM InvoiceResponses IR2
                     WHERE IR2.invoiceID = I.invoiceID
                  )
                  THEN 1
                  ELSE 0
               END AS isMostRecentPaid -- For response rows
            FROM Invoice I
            LEFT JOIN InvoiceResponses IR ON I.invoiceID = IR.invoiceID
            LEFT JOIN WorkOrder WO ON I.workOrderID = WO.workOrderID
            LEFT JOIN QuoteHistory QH ON WO.responseID = QH.responseID
            LEFT JOIN QuoteRequest QR ON QH.quoteID = QR.quoteID
            WHERE 
               I.clientID = ?
               AND EXISTS (   -- stops printing duplicates
                   SELECT 1 FROM InvoiceResponses IR2 WHERE IR2.invoiceID = I.invoiceID
               )
            ORDER BY 
            invoiceID ASC, responseID ASC;


-- GET CLIENT'S INVOICE RESPONSES
    INSERT INTO InvoiceResponses (invoiceID, clientID, responseNote) VALUES (?, ?, ?);

-- GET ACCEPTED INVOICE BY CLIENT
    UPDATE Invoice SET status = 'PAID', datePaid = ? WHERE invoiceID = ?;




----------------------------------------------------------------------
----------------------------------------------------------------------
-------			For David's database		 -------------
----------------------------------------------------------------------
----------------------------------------------------------------------

-- big clients 

SELECT c.clientID, c.firstName, c.lastName, COUNT(wo.workOrderID) AS completed_orders
FROM ClientDB c
JOIN WorkOrder wo ON c.clientID = wo.clientID
WHERE wo.status = 'Completed'
GROUP BY c.clientID
HAVING completed_orders = (
    SELECT MAX(order_count)
    FROM (
        SELECT COUNT(wo2.workOrderID) AS order_count
        FROM WorkOrder wo2
        WHERE wo2.status = 'Completed'
        GROUP BY wo2.clientID
    ) AS subquery
);


-- difficult clients

SELECT c.clientID, c.firstName, c.lastName
FROM ClientDB c
JOIN QuoteRequest qr ON c.clientID = qr.clientID
LEFT JOIN QuoteHistory qh ON qr.quoteID = qh.quoteID
WHERE qh.responseID IS NULL
GROUP BY c.clientID
HAVING COUNT(qr.quoteID) = 3;


-- this months Quotes

SELECT qh.responseID, qh.proposedPrice, qh.startDate, qh.endDate
FROM QuoteHistory qh
WHERE qh.status = 'Accepted'
  AND MONTH(qh.responseDATE) = 12
  AND YEAR(qh.responseDATE) = 2024;


-- prospective clients

SELECT c.clientID, c.firstName, c.lastName
FROM ClientDB c
LEFT JOIN QuoteRequest qr ON c.clientID = qr.clientID
WHERE qr.quoteID IS NULL;


-- largest driveway

SELECT qr.propertyAddress, qr.drivewaySqft
FROM QuoteRequest qr
JOIN WorkOrder wo ON qr.quoteID = wo.quoteID
WHERE wo.status = 'Completed'
  AND qr.drivewaySqft = (
    SELECT MAX(drivewaySqft)
    FROM QuoteRequest qr2
    JOIN WorkOrder wo2 ON qr2.quoteID = wo2.quoteID
    WHERE wo2.status = 'Completed'
  );


-- overdue bills

SELECT i.invoiceID, i.clientID, i.amountDue, i.dateCreated
FROM Invoice i
WHERE i.datePaid IS NULL
  AND DATEDIFF(CURDATE(), i.dateCreated) > 7;


-- bad clients 

SELECT DISTINCT c.clientID, c.firstName, c.lastName
FROM ClientDB c
JOIN Invoice i ON c.clientID = i.clientID
WHERE i.datePaid IS NULL
  AND DATEDIFF(CURDATE(), i.dateCreated) > 7;

-- good clients 

SELECT DISTINCT c.clientID, c.firstName, c.lastName
FROM ClientDB c
JOIN Invoice i ON c.clientID = i.clientID
WHERE i.datePaid IS NOT NULL
  AND TIMESTAMPDIFF(HOUR, i.dateCreated, i.datePaid) <= 24;



